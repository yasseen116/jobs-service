{% extends "_base.html" %}

{% block title %}My Profile - Hired{% endblock %}

{% block content %}
<!-- Cropper CSS include -->
<link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
<div class="page" id="app">
    <div class="container" style="margin-top: 40px; margin-bottom: 60px;">

        <div v-if="loading" class="loading-state">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Loading profile...</p>
        </div>

        <div v-else class="profile-layout">

            <aside class="profile-sidebar">
                <div class="content-card user-card">
                    <div class="member-avatar" style="position: relative;">
                        <img :src="user.photo || '../static/images/img-placeholder.png'" alt="User Avatar">
                        <!-- Photo upload controls -->
                        <input type="file" id="profilePhotoInput" @change="handlePhotoUpload" accept="image/*" style="display: none;">
                        <label for="profilePhotoInput" title="Change photo" style="position: absolute; right: 8px; bottom: 8px; background: #0a66c2; color: #fff; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
                            <!-- camera icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        </label>
                        <button v-if="user.photo" type="button" class="btn-icon btn-remove-skill" @click="removePhoto" title="Remove photo" style="position: absolute; left: 8px; bottom: 8px; width: 36px; height: 36px;">&times;</button>
                    </div>
                    <h2 class="user-name">[[ user.name ]]</h2>
                    <p class="user-title">[[ user.jobTitle ]]</p>
                    <p class="user-email">[[ user.email ]]</p>

                    <hr class="divider">

                    <div class="sidebar-stats">
                        <div class="stat">
                            <strong>[[ applications.length ]]</strong>
                            <span>Applied</span>
                        </div>
                        <div class="stat">
                            <strong>[[ user.skills.length ]]</strong>
                            <span>Skills</span>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="profile-content">

                <form @submit.prevent="saveProfile" class="profile-form">

                    <div class="content-card">
                        <h3 class="card-header">Personal Information</h3>

                        <div class="form-row">
                            <div class="form-group half">
                                <label>Full Name</label>
                                <input type="text" v-model="user.name" placeholder="John Doe" required>
                            </div>
                            <div class="form-group half">
                                <label>Job Title</label>
                                <input type="text" v-model="user.jobTitle" placeholder="e.g. Software Engineer" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group half">
                                <label>Phone Number</label>
                                <input type="text" v-model="user.phone" placeholder="+20 1xx xxxx xxx">
                            </div>
                            <div class="form-group half">
                                <label>Location</label>
                                <input type="text" v-model="user.location" placeholder="Cairo, Egypt">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>About Me</label>
                            <textarea v-model="user.about" rows="4" placeholder="Briefly describe your professional background..."></textarea>
                        </div>
                    </div>

                    <div class="content-card">
                        <h3 class="card-header">Skills</h3>
                        <div class="form-group" style="position: relative;">
                            <transition-group name="skill-list" tag="div">
                                <div v-for="(skill, index) in user.skills" :key="skill.id" class="skill-row">
                                    <input type="text" v-model="skill.value" placeholder="e.g. Python" required>

                                    <button v-if="user.skills.length > 1" type="button" class="btn-icon btn-remove-skill" @click="removeSkill(index)">&times;</button>
                                    <button v-if="index === user.skills.length - 1" type="button" class="btn-icon btn-add" @click="addSkill">+</button>
                                </div>
                            </transition-group>
                            <button v-if="user.skills.length === 0" type="button" class="btn btn-card-details" @click="addSkill">Add Skill</button>
                        </div>
                    </div>

                    <div class="profile-content-card">
                        <h3 class="card-header">Work Experience</h3>
                        <div class="form-group" style="position: relative;">

                            <transition-group name="skill-list" tag="div">
                                <div v-for="(exp, index) in user.experience" :key="exp.id" class="skill-row">
                                    <input type="text" v-model="exp.role" placeholder="Role (e.g. Dev)" required>
                                    <input type="text" v-model="exp.company" placeholder="Company" required>
                                    <input type="text" v-model="exp.years" placeholder="Years" style="max-width: 120px;" required>

                                    <button v-if="user.experience.length > 0" type="button" class="btn-icon btn-remove-skill" @click="removeExperience(index)">&times;</button>
                                    <button v-if="index === user.experience.length - 1" type="button" class="btn-icon btn-add" @click="addExperience">+</button>
                                </div>
                            </transition-group>

                            <button v-if="user.experience.length === 0" type="button" class="btn btn-card-details" @click="addExperience">
                                + Add Work Experience
                            </button>
                        </div>
                    </div>

                    <div class="profile-content-card">
                        <h3 class="card-header">Education</h3>
                        <div class="form-group" style="position: relative;">

                            <transition-group name="skill-list" tag="div">
                                <div v-for="(edu, index) in user.education" :key="edu.id" class="skill-row">
                                    <input type="text" v-model="edu.degree" placeholder="Degree" required>
                                    <input type="text" v-model="edu.university" placeholder="University" required>
                                    <input type="text" v-model="edu.year" placeholder="Year" style="max-width: 120px;" required>

                                    <button v-if="user.education.length > 0" type="button" class="btn-icon btn-remove-skill" @click="removeEducation(index)">&times;</button>
                                    <button v-if="index === user.education.length - 1" type="button" class="btn-icon btn-add" @click="addEducation">+</button>
                                </div>
                            </transition-group>

                            <button v-if="user.education.length === 0" type="button" class="btn btn-card-details" @click="addEducation">
                                + Add Education
                            </button>
                        </div>
                    </div>

                    <div class="profile-content-card">
                        <h3 class="card-header">Resume / CV</h3>

                        <div v-if="user.cvName" class="cv-preview-box">
                            <div class="cv-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            </div>
                            <div class="cv-info">
                                <span class="cv-name">[[ user.cvName ]]</span>
                                <span class="cv-label">Current Resume</span>
                            </div>
                            <div class="cv-actions">
                                <label for="replaceCv" style="cursor: pointer; margin-right: 10px; color: #0a66c2; font-weight: 600; padding-top: 6px;">Replace</label>
                                <input type="file" id="replaceCv" @change="handleFileUpload" style="display: none;" accept=".pdf,.doc,.docx">

                                <button type="button" class="btn-icon btn-preview" style="width: 35px; height: 35px; margin-right: 5px;" @click="previewCv" title="Preview Resume">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                </button>

                                <button type="button" class="btn-icon btn-remove-skill" style="width: 35px; height: 35px;" @click="removeCv" title="Remove Resume">&times;</button>
                            </div>
                        </div>

                        <div v-else class="form-group">
                            <input type="file" id="cv" @change="handleFileUpload" accept=".pdf,.doc,.docx" style="display: none;">
                            <label for="cv" class="custom-file-upload">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                <span>Upload your Resume</span>
                            </label>
                        </div>
                    </div>

                    <div style="text-align: right; margin-bottom: 40px;">
                        <button type="submit" class="btn btn-apply-large" :disabled="isSaving">
                            [[ isSaving ? 'Saving Changes...' : 'Save Profile' ]]
                        </button>
                    </div>

                </form>

                <div class="profile-content-card">
                    <h3 class="card-header">Applied Jobs</h3>

                    <div v-if="applications.length === 0" style="color: #666; font-style: italic; padding: 10px;">
                        You haven't applied to any jobs yet.
                    </div>

                    <div v-else class="applications-list">
                        <div class="app-item" v-for="app in applications" :key="app.id">
                            <div class="app-info">
                                <h4 class="app-job-title">[[ app.jobTitle ]] at [[ app.company ]]</h4>
                                <span class="app-date">Applied on: [[ app.appliedAt ]]</span>
                            </div>
                            <div class="app-status">
                                <span class="status-badge" :class="getStatusClass(app.status)">
                                    [[ app.status ]]
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <transition name="delete-pop">
            <div class="modal-overlay"  v-if="showDeleteModal" @click.self="closeDeleteModal">
                <div class="modal-card" style="max-width: 400px; padding: 30px; text-align: center;">

                    <div style="font-size: 3rem; color: #ef4444; margin-bottom: 15px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                    </div>

                    <h3 style="margin-top: 0; color: #333;">Delete Resume?</h3>
                    <p style="color: #666; margin-bottom: 25px;">Are you sure you want to remove your resume? This action cannot be undone.</p>

                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-card-details" @click="closeDeleteModal" style="flex: 1;">Cancel</button>
                        <button class="btn" @click="confirmDeleteCv" style="flex: 1; background-color: #ef4444; color: white; border: none;">Delete</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- NEW: Crop photo modal -->
        <transition name="delete-pop">
            <div class="modal-overlay" v-if="showCropModal" @click.self="closeCropper">
                <div class="crop-modal-card" style="max-width: 680px; width: 100%;">
                    <h3 style="margin-top: 0; color: #333;">Crop your photo</h3>
                    <p style="color: #666; margin-top: -8px;">Adjust the square crop as you like, then click Save.</p>
                    <div style="width: 100%; max-height: 65vh; overflow: hidden; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <img :src="tempImageUrl" ref="cropperImage" alt="Crop preview" style="max-width: 100%; display: block;">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                        <button class="btn btn-card-details" type="button" @click="closeCropper">Cancel</button>
                        <button class="btn btn-apply-large" type="button" @click="confirmCrop">Save</button>
                    </div>
                </div>
            </div>
        </transition>

        <div v-if="showSuccessNotification" class="toast-notification success">
            <div class="toast-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </div>
            <span>[[ successMessage ]]</span>
        </div>

        <div v-if="showErrorNotification" class="toast-notification error">
            <div class="toast-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
            </div>
            <span>[[ errorMessage ]]</span>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="../static/js/model.js"></script>
<!-- Cropper JS include -->
<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script src="../static/js/profile.js"></script>
{% endblock %}